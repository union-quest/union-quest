{"version":3,"file":"NavButton-7688252c.js","sources":["../../../../../src/lib/blockchain/contracts.ts","../../../../../src/lib/time.ts","../../../../../src/lib/blockchain/chainTempo.ts","../../../../../src/lib/blockchain/wallet.ts","../../../../../src/lib/components/styled/navigation/NavButton.svelte"],"sourcesContent":["import _contractsInfos from '$lib/contracts.json';\nimport {readable} from 'svelte/store';\n\nexport const initialContractsInfos = _contractsInfos;\n\nlet _set;\nexport const contractsInfos = readable(_contractsInfos, (set) => {\n  _set = set;\n});\n\nif (import.meta.hot) {\n  import.meta.hot.accept((newModule) => {\n    _set(newModule.initialContractsInfos);\n  });\n}\n","import {blockTime} from '$lib/config';\nimport {readable} from 'svelte/store';\n\nconst performanceAvailable = typeof performance !== 'undefined'; // server\n\nexport let startTime = performanceAvailable ? (Date.now() - performance.now()) / 1000 : Date.now() / 1000;\n\nexport function now(): number {\n  if (performanceAvailable) {\n    return Math.floor(performance.now() / 1000) + startTime;\n  } else {\n    return Math.floor(Date.now() / 1000) + startTime;\n  }\n}\n\nlet _corrected = false;\nexport function correctTime(actualTime: number): void {\n  const currentTime = now();\n  const diff = actualTime - currentTime;\n  if (Math.abs(diff) > blockTime) {\n    // only adapt if difference is significant\n    startTime += diff;\n  }\n  _corrected = true;\n}\n\nexport function isCorrected(): boolean {\n  return _corrected;\n}\n\nexport const time = readable(now(), function start(set) {\n  const interval = setInterval(() => {\n    set(now());\n  }, 1000);\n\n  return function stop() {\n    clearInterval(interval);\n  };\n});\n\nif (typeof window !== 'undefined') {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  (window as unknown as any).time = {\n    now,\n    startTime,\n    correctTime,\n    isCorrected,\n    time,\n  };\n}\n","import {blockTime} from '$lib/config';\nimport type {Provider} from '@ethersproject/abstract-provider';\nimport {logs} from 'named-logs';\nimport type {Readable} from 'svelte/store';\nconst console = logs('chainTempo');\n\nfunction removeFrom(array: unknown[], elem: unknown): void {\n  for (let i = array.length - 1; i >= 0; i--) {\n    if (array[i] === elem) {\n      array.splice(i, 1);\n      return;\n    }\n  }\n  console.log('NOT FOUND');\n}\n\nexport type ChainTempoInfo = {lastBlockNumber?: number; stale: boolean};\n\nexport type TempoListener = (chainInfo: ChainTempoInfo) => void;\n\nclass ChainTempo implements Readable<ChainTempoInfo> {\n  private blockListeners: TempoListener[] = [];\n  private currentProvider?: Provider = undefined;\n  private callback: () => void;\n  private timeout: NodeJS.Timeout;\n  private lastUpdate = 0;\n  private triggerTimeout: NodeJS.Timeout;\n  public readonly chainInfo: ChainTempoInfo = {lastBlockNumber: undefined, stale: true};\n\n  constructor(private maxTimeout: number) {}\n\n  subscribe(func: TempoListener): () => void {\n    func(this.chainInfo);\n    this.blockListeners.push(func);\n    return removeFrom.bind(null, this.blockListeners, func);\n  }\n\n  check() {\n    const now = Date.now() / 1000;\n    if (now - this.lastUpdate > this.maxTimeout - 1) {\n      console.info(`timed out... ${now}  - ${this.lastUpdate} = ${now - this.lastUpdate} > ${this.maxTimeout - 1}`);\n      this.onBlock(undefined);\n    }\n    this.timeout = setTimeout(this.check.bind(this), this.maxTimeout * 1000);\n  }\n\n  startOrUpdateProvider(provider?: Provider) {\n    if (this.currentProvider !== provider) {\n      if (this.currentProvider) {\n        console.info('stop listening for block event');\n        this.currentProvider.off('block', this.callback);\n      }\n      this.callback = this.onBlock.bind(this);\n      this.currentProvider = provider;\n      if (this.currentProvider) {\n        console.info('listening for block event');\n        this.currentProvider.on('block', this.callback);\n      }\n    }\n\n    // fallback on time as provider might not be available\n    if (!this.timeout) {\n      this.timeout = setTimeout(this.check.bind(this), this.maxTimeout * 1000);\n    }\n  }\n  private onBlock(blockNumber?: number) {\n    if (blockNumber) {\n      this.chainInfo.lastBlockNumber = blockNumber;\n      this.chainInfo.stale = false;\n    } else {\n      this.chainInfo.stale = true;\n    }\n    this.lastUpdate = Date.now() / 1000;\n    this.triggerListeners();\n  }\n\n  private triggerListeners() {\n    if (this.triggerTimeout) {\n      clearTimeout(this.triggerTimeout);\n    }\n    this.triggerTimeout = setTimeout(this.callListeners.bind(this), 0);\n  }\n\n  private callListeners() {\n    console.info(`onBlock ${this.chainInfo.lastBlockNumber}`);\n\n    for (const listener of this.blockListeners) {\n      // TODO delay them ?\n      listener(this.chainInfo); // TODO wait for each one ?\n    }\n    // TODO wait for them (if delayed) before triggering the next update?\n  }\n}\n\nexport const chainTempo = new ChainTempo(blockTime * 6);\n","import {initWeb3W} from 'web3w';\nimport {WalletConnectModuleLoader} from 'web3w-walletconnect-loader';\nimport {contractsInfos} from '$lib/blockchain/contracts';\nimport {notifications} from '../web/notifications';\nimport {webWalletURL, finality, fallbackProviderOrUrl, chainId, localDev} from '$lib/config';\nimport {isCorrected, correctTime} from '$lib/time';\nimport {base} from '$app/paths';\nimport {chainTempo} from '$lib/blockchain/chainTempo';\nimport * as Sentry from '@sentry/browser';\nimport {get} from 'svelte/store';\n\nconst walletStores = initWeb3W({\n  chainConfigs: get(contractsInfos),\n  builtin: {autoProbe: true},\n  transactions: {\n    autoDelete: false,\n    finality,\n  },\n  flow: {\n    autoUnlock: true,\n  },\n  autoSelectPrevious: true,\n  localStoragePrefix: (base && base.startsWith('/ipfs/')) || base.startsWith('/ipns/') ? base.slice(6) : undefined, // ensure local storage is not conflicting across web3w-based apps on ipfs gateways\n  options: [\n    'builtin',\n    new WalletConnectModuleLoader({\n      nodeUrl: typeof fallbackProviderOrUrl === 'string' ? fallbackProviderOrUrl : undefined,\n      chainId,\n      infuraId: 'bc0bdd4eaac640278cdebc3aa91fabe4',\n    }),\n  ],\n  fallbackNode: fallbackProviderOrUrl,\n  checkGenesis: localDev,\n});\n\nexport const {wallet, transactions, builtin, chain, balance, flow, fallback} = walletStores;\n\nfunction notifyFailure(tx: {hash: string}) {\n  notifications.queue({\n    id: tx.hash,\n    delay: 0,\n    title: 'Transaction Error',\n    text: 'The Transaction failed',\n    type: 'error',\n    onAcknowledge: () => transactions.acknowledge(tx.hash, 'failure'),\n  });\n}\n\nfunction notifyCancelled(tx: {hash: string}) {\n  notifications.queue({\n    id: tx.hash,\n    delay: 3,\n    title: 'Transaction Cancelled',\n    text: 'The Transaction Has Been Replaced',\n    type: 'info',\n    onAcknowledge: () => transactions.acknowledge(tx.hash, 'cancelled'),\n  });\n}\n\ntransactions.subscribe(($transactions) => {\n  for (const tx of $transactions.concat()) {\n    if (tx.confirmations > 0 && !tx.acknowledged) {\n      if (tx.status === 'failure') {\n        notifyFailure(tx);\n      } else if (tx.status === 'cancelled') {\n        notifyCancelled(tx);\n      } else {\n        // auto acknowledge\n        transactions.acknowledge(tx.hash, tx.status);\n      }\n    }\n  }\n});\n\nchain.subscribe(async (v) => {\n  chainTempo.startOrUpdateProvider(wallet.provider);\n  if (!isCorrected()) {\n    if (v.state === 'Connected' || v.state === 'Ready') {\n      const latestBlock = await wallet.provider?.getBlock('latest');\n      if (latestBlock) {\n        correctTime(latestBlock.timestamp);\n      }\n    }\n  }\n});\n\nfallback.subscribe(async (v) => {\n  if (!isCorrected()) {\n    if (v.state === 'Connected' || v.state === 'Ready') {\n      const latestBlock = await wallet.provider?.getBlock('latest');\n      if (latestBlock) {\n        correctTime(latestBlock.timestamp);\n      }\n    }\n  }\n});\n\nlet lastAddress: string | undefined;\nwallet.subscribe(async ($wallet) => {\n  if (lastAddress !== $wallet.address) {\n    lastAddress = $wallet.address;\n    Sentry.setUser({address: $wallet.address});\n  }\n});\n\n// TODO remove\nif (typeof window !== 'undefined') {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  (window as any).walletStores = walletStores;\n}\n\nchainTempo.startOrUpdateProvider(wallet.provider);\n\ncontractsInfos.subscribe(async ($contractsInfo) => {\n  await chain.updateContracts($contractsInfo);\n});\n","<script lang=\"ts\">\n  let _class = '';\n  export {_class as class};\n\n  export let href: string = undefined;\n  export let blank = false;\n  export let label: string;\n\n  export let big = false;\n  export let active = false;\n  export let disabled = false;\n  export let waitOnDisabled = false;\n\n  export let secondary = false;\n  export let tertiary = false;\n  export let danger = false;\n  export let white = false;\n  $: primary = !secondary && !tertiary && !danger && !white;\n\n  export let customPadding = '';\n\n  let sizeClasses: string;\n  $: {\n    sizeClasses = `${customPadding || 'px-4 py-2'} text-sm border-2 space-x-1 rounded-md sm:leading-5`;\n    if (big) {\n      sizeClasses = `${\n        customPadding || 'px-8 py-3 md:px-10 md:py-4'\n      } border-4 leading-6 space-x-3 rounded-lg md:text-lg `;\n    }\n  }\n\n  let colorClasses: string;\n  let hoverClasses: string;\n  let focusClasses: string;\n  let activeClasses: string;\n  let activatedClasses: string;\n  let disabledClasses: string;\n  $: {\n    hoverClasses = 'hover:-translate-y-px ';\n    focusClasses = 'focus:-translate-y-px ';\n    activeClasses = 'active:-translate-y-px ';\n    activatedClasses = '-translate-y-px ';\n    disabledClasses = 'opacity-50 ' + (waitOnDisabled ? 'cursor-wait ' : '');\n\n    if (primary) {\n      colorClasses = ` text-white bg-yellow-600`;\n      hoverClasses += ` hover:bg-yellow-500`;\n      focusClasses += ` focus-not-active:bg-yellow-500`;\n      activeClasses += ` active:bg-yellow-600 active:border-yellow-500`;\n      activatedClasses += ` bg-yellow-600 border-yellow-500`;\n    } else if (secondary) {\n      colorClasses = `text-pink-600 bg-gray-100 dark:text-pink-500 dark:bg-gray-900`;\n      hoverClasses += ` hover:bg-gray-50 dark:hover:bg-gray-800`;\n      focusClasses += ` focus-not-active:bg-gray-50 dark:focus-not-active:bg-gray-800`;\n      activeClasses += ` active:bg-gray-100 active:border-gray-50 dark:active:bg-gray-900 dark:active:border-gray-800 `;\n      activatedClasses += ` bg-gray-100 border-gray-50 dark:bg-gray-900 dark:border-gray-800`;\n    } else if (tertiary) {\n      colorClasses = `text-gray-500 dark:text-gray-400`;\n      hoverClasses += ` hover:text-gray-600 hover:bg-gray-50 dark:hover:text-gray-300 dark:hover:bg-gray-900`;\n      focusClasses += ` focus-not-active:text-gray-600 focus-not-active:bg-gray-50 dark:focus-not-active:text-gray-300 dark:focus-not-active:bg-gray-900`;\n      activeClasses += ` active:text-gray-600 active:bg-white active:border-gray-50 dark:active:text-gray-300 dark:active:bg-black dark:active:border-gray-900`;\n      activatedClasses += ` bg-transparent text-gray-600 border-gray-50 dark:text-gray-300 dark:border-gray-900`;\n    } else if (danger) {\n      colorClasses = `text-red-700 bg-red-100`;\n      hoverClasses += ` hover:bg-red-50`;\n      focusClasses += ` focus-not-active:bg-red-50`;\n      activeClasses += ` active:bg-red-100`;\n      activatedClasses += ` bg-red-100`;\n    } else if (white) {\n      colorClasses = `text-pink-600 bg-white`;\n      hoverClasses += ` hover:text-pink-500`;\n      focusClasses += ` focus-not-active:text-pink-500`;\n      activeClasses += ` active:text-pink-600`;\n      activatedClasses += ` text-pink-600`;\n    }\n  }\n\n  $: classes = `w-full flex items-center justify-center font-medium select-none transition transform duration-150 ease-in-out focus:outline-none ${colorClasses} ${sizeClasses} ${\n    disabled\n      ? disabledClasses\n      : active\n      ? activatedClasses\n      : `border-transparent ${hoverClasses} ${focusClasses} ${activeClasses}`\n  } ${_class}`;\n</script>\n\n<a\n  on:click\n  aria-label={label}\n  title={label}\n  {href}\n  rel={blank === true ? 'noopener' : ''}\n  target={blank === true ? '_blank' : ''}\n  {disabled}\n  class={classes}\n>\n  <slot />\n</a>\n"],"names":["get","chainId"],"mappings":"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"}